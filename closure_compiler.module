<?php
// $Id$

define("CLOSURE_COMPILER_SERVICE_URL", "http://closure-compiler.appspot.com/compile");
define("CLOSURE_COMPILER_SIGNATURE", "/* optimized by closure_compiler module using google closure compiler api */");

function closure_compiler_menu() {
	$items = array ();
	$items['admin/settings/closure_compiler'] = array (
		'title' => 'Google Closure Compiler Settings',
		'description' => 'Configure Google Closure Compiler Service settings.',
		'page callback' => 'drupal_get_form',
		'page arguments' => array (
			'closure_compiler_settings'
		),
		'access arguments' => array (
			'administer site configuration'
		),
		'type' => MENU_NORMAL_ITEM,
		'file' => 'closure_compiler.admin.inc',
		
	);
	return $items;
}
function closure_compiler_cron() { 
	if (variable_get('closure_compiler_service', FALSE) && variable_get('preprocess_js', 0)) {
		closure_compiler_compile();	
	}	
}
function closure_compiler_compile() {
	$js_path = file_create_path('js');
	$js_files = scandir($js_path);
	$process_limit = variable_get('closure_compiler_process_limit', 0);
	foreach ($js_files as $key => $filename) {
		if (substr($filename, 0, 3) != 'js_') {
			unset ($js_files[$key]);
		}
	}
	if (empty ($js_files)) {
		drupal_set_message('No aggregated javascript files found at ' . check_plain($js_path) . '.');
		return;
	}
	// Get ready to send js files to closure compiler service
	$success = $failed = 0;
	foreach ($js_files as $filename) {
		$filepath = $js_path . '/' . $filename;
		// If the file has already been optimized, do not send it to the service
		if (!($js = file_get_contents($filepath)) || (substr($js, 0, strlen(CLOSURE_COMPILER_SIGNATURE)) == CLOSURE_COMPILER_SIGNATURE)) {
			continue;
		}
		$params = array (
			'js_code' => $js,
			'compilation_level' => 'SIMPLE_OPTIMIZATIONS',
			'output_info' => 'compiled_code',
			'output_format' => 'text'			
		);
		$headers = array (
			'Content-Type' => 'application/x-www-form-urlencoded'
		);
		$response = drupal_http_request(CLOSURE_COMPILER_SERVICE_URL, $headers, 'POST', http_build_query($params, '', '&'));
		if ($response->code == 200 && $response->data) {
			// Success, write it back to the file
			$contents = CLOSURE_COMPILER_SIGNATURE . $response->data;
			if (file_put_contents($filepath, $contents)) {
				$success++;
			} else {
				$failed++;
			}
		} else {
			$failed++;
		}
		// Terminate the process if we hit the limit
		if ($process_limit && ($success+$failed) == $process_limit) {
			break;
		}
	}
	watchdog('closure_compiler', t('Successfully compiled @success javascript files, @fail failed.', array (
		'@success' => $success,
		'@fail' => $failed
	)));
}